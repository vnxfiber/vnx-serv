{% extends "adm/base.html" %}

{% block title %}Notificações{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Notificações</h4>
        <button class="btn btn-sm btn-outline-secondary" onclick="markAllAsRead()">
            <i class="fas fa-check-double"></i> Marcar todas como lidas
        </button>
    </div>

    <!-- Notifications List -->
    <div class="notifications-list">
        {% if notifications %}
            {% for notification in notifications %}
                <div class="notification-item card mb-2 {% if not notification.read %}unread{% endif %}" 
                     data-id="{{ notification.id }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="notification-title mb-1">
                                    <i class="fas fa-{{ notification.type|default('info')|notification_icon }} me-2 text-{{ notification.type|default('info') }}"></i>
                                    {{ notification.title }}
                                </h6>
                                <p class="notification-message mb-1">{{ notification.message }}</p>
                                <small class="text-muted">{{ notification.created_at|datetime }}</small>
                            </div>
                            {% if not notification.read %}
                                <button class="btn btn-sm btn-link text-muted" 
                                        onclick="markAsRead('{{ notification.id }}')"
                                        title="Marcar como lida">
                                    <i class="fas fa-check"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                <p class="text-muted">Nenhuma notificação encontrada.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .notifications-list {
        max-width: 800px;
        margin: 0 auto;
    }

    .notification-item {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

    .notification-item.unread {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        border-left-color: var(--primary-color);
    }

    .notification-title {
        font-weight: 600;
        color: var(--primary-color);
    }

    .notification-message {
        color: #666;
        font-size: 0.9rem;
    }

    /* Ícones por tipo de notificação */
    .fa-success { color: var(--success-color); }
    .fa-danger { color: var(--danger-color); }
    .fa-warning { color: var(--warning-color); }
    .fa-info { color: var(--primary-color); }
</style>
{% endblock %}

{% block extra_js %}
<script>
    async function markAsRead(notificationId) {
        try {
            const response = await fetch('/adm/notifications/mark-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    notification_ids: [notificationId]
                })
            });

            if (response.ok) {
                // Remove a classe unread e o botão de marcar como lida
                const notification = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
                if (notification) {
                    notification.classList.remove('unread');
                    const button = notification.querySelector('button');
                    if (button) button.remove();
                }
                
                // Atualiza o contador de notificações no header
                updateNotificationBadge();
            } else {
                showToast('Erro', 'Não foi possível marcar a notificação como lida.', 'danger');
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('Erro', 'Ocorreu um erro ao marcar a notificação como lida.', 'danger');
        }
    }

    async function markAllAsRead() {
        try {
            const response = await fetch('/adm/notifications/mark-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    notification_ids: []
                })
            });

            if (response.ok) {
                // Remove a classe unread e os botões de todas as notificações
                document.querySelectorAll('.notification-item.unread').forEach(notification => {
                    notification.classList.remove('unread');
                    const button = notification.querySelector('button');
                    if (button) button.remove();
                });
                
                // Atualiza o contador de notificações no header
                updateNotificationBadge();
                
                showToast('Sucesso', 'Todas as notificações foram marcadas como lidas.', 'success');
            } else {
                showToast('Erro', 'Não foi possível marcar as notificações como lidas.', 'danger');
            }
        } catch (error) {
            console.error('Erro:', error);
            showToast('Erro', 'Ocorreu um erro ao marcar as notificações como lidas.', 'danger');
        }
    }
</script>
{% endblock %} 