from flask import Flask, render_template, request, redirect, url_for, session, flash, jsonify
import os
from werkzeug.security import generate_password_hash, check_password_hash

# Inicializa o Flask
app = Flask(__name__, 
           template_folder='.', # Usando o diretório raiz do projeto
           static_folder='static',
           static_url_path='/static')
app.secret_key = 'chave_secreta_temporaria'  # Em produção, use os.urandom(24)

# Rota principal
@app.route('/')
def home():
    return redirect(url_for('admin_login'))

# Rota para login de admin
@app.route('/adm')
@app.route('/adm/login', methods=['GET', 'POST'])
def admin_login():
    if request.method == 'POST':
        email = request.form.get('email')
        password = request.form.get('password')
        
        # Lógica simplificada - apenas para demonstração
        if email == 'admin@example.com' and password == 'senha123':
            session['admin_user'] = email
            flash('Login realizado com sucesso!', 'success')
            return redirect(url_for('admin_dashboard'))
        else:
            flash('Email ou senha inválidos.', 'danger')
    
    return '''
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Login - Painel Administrativo</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container">
            <div class="row justify-content-center mt-5">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-body p-4">
                            <div class="text-center mb-4">
                                <h2 class="fw-bold">Painel Administrativo</h2>
                                <p class="text-muted">Entre com suas credenciais de acesso</p>
                            </div>

                            <form action="/adm/login" method="post">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email:</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input type="email" id="email" name="email" class="form-control" required placeholder="Seu email">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha:</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input type="password" id="password" name="password" class="form-control" required placeholder="Sua senha">
                                    </div>
                                </div>
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary py-2">
                                        <i class="fas fa-sign-in-alt me-2"></i>Entrar
                                    </button>
                                </div>
                            </form>

                            <div class="text-center mt-4">
                                <p>Não tem uma conta? <a href="/adm/cadastro">Cadastre-se</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
    '''

# Rota para cadastro de admin
@app.route('/adm/cadastro', methods=['GET', 'POST'])
def admin_cadastro():
    if request.method == 'POST':
        nome = request.form.get('nome', '')
        username = request.form.get('username', '')
        email = request.form.get('email', '')
        password = request.form.get('password', '')
        telefone = request.form.get('telefone', '')
        
        # Verificar dados obrigatórios
        if not email or not password:
            return '''
            <html>
            <head>
                <title>Erro no Cadastro</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body>
                <div class="container mt-5">
                    <div class="alert alert-danger">Email e senha são obrigatórios.</div>
                    <a href="/adm/cadastro" class="btn btn-primary">Voltar</a>
                </div>
            </body>
            </html>
            '''
        
        # Simulação de cadastro bem-sucedido
        flash('Cadastro realizado com sucesso! Faça o login.', 'success')
        return redirect(url_for('admin_login'))
        
    # Se for método GET, mostra o formulário de cadastro    
    return '''
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Cadastro de Administrador</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-body p-4">
                            <h2 class="text-center mb-4">Cadastro de Administrador</h2>
                            
                            <form action="/adm/cadastro" method="post">
                                <div class="mb-3">
                                    <label for="nome" class="form-label">Nome Completo:</label>
                                    <input type="text" id="nome" name="nome" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="username" class="form-label">Nome de Usuário:</label>
                                    <input type="text" id="username" name="username" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email:</label>
                                    <input type="email" id="email" name="email" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha:</label>
                                    <input type="password" id="password" name="password" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="telefone" class="form-label">Telefone:</label>
                                    <input type="tel" id="telefone" name="telefone" class="form-control">
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                                </div>
                            </form>
                            
                            <div class="text-center mt-3">
                                <p>Já tem uma conta? <a href="/adm">Faça login</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
    '''

# Rota para o dashboard do admin
@app.route('/adm/dashboard')
def admin_dashboard():
    if 'admin_user' not in session:
        return redirect(url_for('admin_login'))
    
    return '''
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard - Painel Administrativo</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container mt-5">
            <h1>Dashboard Administrativo</h1>
            <p>Bem-vindo ao painel administrativo!</p>
            <a href="/adm/logout" class="btn btn-danger">Sair</a>
        </div>
    </body>
    </html>
    '''

# Rota para logout
@app.route('/adm/logout')
def admin_logout():
    session.pop('admin_user', None)
    flash('Logout realizado com sucesso.', 'success')
    return redirect(url_for('admin_login'))

# Iniciar o servidor quando o arquivo é executado diretamente
if __name__ == '__main__':
    print("Servidor Flask iniciando...")
    app.run(debug=True) 