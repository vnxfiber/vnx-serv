{% extends "admin/base.html" %}

{% block title %}Modo Desenvolvedor{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para a página de desenvolvedor */
    .logs-container {
        font-family: monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-all;
    }
    
    pre code {
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    
    /* Garanta que todos os alertas tenham um z-index alto para ficarem visíveis */
    .alert {
        z-index: 1030;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i> Ferramentas de Desenvolvimento</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i> Atenção: Estas ferramentas são destinadas apenas para desenvolvimento e testes.
                                        </div>
                    
                    <div class="row mt-4">
                        <!-- Painel de Debug -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="fas fa-bug me-2"></i> Controle de Debug</h6>
                                        </div>
                                    <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="debugModeSwitch">
                                        <label class="form-check-label" for="debugModeSwitch">Ativar modo debug</label>
                                        </div>
                                    <div class="mb-3">
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="testarDB()">
                                            <i class="fas fa-database me-1"></i> Testar Conexão DB
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="verificarEstrutura()">
                                            <i class="fas fa-table me-1"></i> Verificar Estrutura
                                        </button>
                                    </div>
                                    <div id="resultadoTeste" class="alert mt-3" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                        <!-- Geração de Dados de Teste -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-vial me-2"></i> Dados de Teste</h6>
                                        </div>
                                <div class="card-body">
                                        <div class="mb-3">
                                        <button class="btn btn-sm btn-primary me-2" onclick="abrirModalGerarDados()">
                                            <i class="fas fa-plus-circle me-1"></i> Gerar Dados
                                            </button>
                                        <button class="btn btn-sm btn-danger me-2" onclick="limparDadosTeste()">
                                            <i class="fas fa-trash me-1"></i> Limpar Dados de Teste
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="verificarTabelaParceiros()">
                                            <i class="fas fa-table me-1"></i> Verificar Tabela Parceiros
                                            </button>
                                        </div>
                                    <div id="resultadoDados" class="alert mt-3" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                        <!-- Formulário para inserir parceiro de teste -->
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-user-plus me-2"></i> Inserir Parceiro de Teste</h6>
                                </div>
                                    <div class="card-body">
                                    <form id="formParceiroTeste" onsubmit="enviarParceiro(event)">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="nomeParceiro" class="form-label">Nome Completo</label>
                                                <input type="text" class="form-control" id="nomeParceiro" name="nome_completo" value="Paulo Silva" required>
                                                <small class="text-muted">Apenas letras, espaços, apóstrofos, pontos e hifens</small>
                                    </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="emailParceiro" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="emailParceiro" name="email" value="teste@exemplo.com" required>
                                                <small class="text-muted">Deve ser um email único</small>
                                </div>
                            </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="whatsappParceiro" class="form-label">WhatsApp (11 dígitos)</label>
                                                <input type="text" class="form-control" id="whatsappParceiro" name="whatsapp" pattern="[0-9]{11}" title="Digite exatamente 11 dígitos numéricos" placeholder="99999999999" required>
                                                <small class="text-muted">Formato: DDD + número (apenas números, exatamente 11 dígitos, deve ser único)</small>
                                    </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="cidadeParceiro" class="form-label">Cidade</label>
                                                <input type="text" class="form-control" id="cidadeParceiro" name="cidade" value="Sao Luis" required>
                                                <small class="text-muted">Evite acentos para maior compatibilidade</small>
                                </div>
                            </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="estadoParceiro" class="form-label">Estado</label>
                                                <select class="form-select" id="estadoParceiro" name="estado" required>
                                                    <option value="MA" selected>Maranhão</option>
                                                    <option value="PI">Piauí</option>
                                                    <option value="CE">Ceará</option>
                                                    <option value="PA">Pará</option>
                                                    <option value="PE">Pernambuco</option>
                                                </select>
                                    </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="especialidadesParceiro" class="form-label">Especialidades</label>
                                                <select class="form-select" id="especialidadesParceiro" name="especialidades" multiple required>
                                                    <option value="Solucoes ISP" selected>Soluções ISP</option>
                                                    <option value="Telefonia VoIP">Telefonia VoIP</option>
                                                    <option value="Fibra Óptica">Fibra Óptica</option>
                                                    <option value="Servidores TI">Servidores TI</option>
                                                    <option value="Infraestrutura Fisica">Infraestrutura Física</option>
                                                    <option value="Wi-Fi Corporativo">Wi-Fi Corporativo</option>
                                                    <option value="Radio Comunicacao">Rádio Comunicação</option>
                                                    <option value="Consultoria">Consultoria</option>
                                                </select>
                                                <small class="text-muted">Segure CTRL para selecionar múltiplas opções</small>
                                </div>
                            </div>
                                        <div class="mb-3">
                                            <label for="experienciaParceiro" class="form-label">Experiência</label>
                                            <textarea class="form-control" id="experienciaParceiro" name="experiencia" rows="3">Testando instalacao e configuracao de equipamentos de rede.</textarea>
                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="isTestData" name="is_test_data" checked>
                                            <label class="form-check-label" for="isTestData">
                                                Marcar como dado de teste (facilita remoção posterior)
                                            </label>
                    </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i> Inserir Parceiro de Teste
                            </button>
                                    </form>
                                    
                                    <!-- Elementos para exibir resultados -->
                                    <div id="alertaResultado" class="alert mt-3" style="display: none;"></div>
                                    <div id="mensagemResultado" class="mt-3" style="display: none;"></div>
                        </div>
                        </div>
                    </div>

                        <!-- Visualização de Logs -->
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0"><i class="fas fa-list-alt me-2"></i> Logs do Sistema</h6>
                        </div>
                        <div class="card-body">
                                    <div class="mb-3">
                                        <button class="btn btn-sm btn-outline-dark me-2" onclick="visualizarLogs()">
                                            <i class="fas fa-sync-alt me-1"></i> Atualizar Logs
                                        </button>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="showDebugLogs" checked>
                                            <label class="form-check-label" for="showDebugLogs">Debug</label>
                                </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="showInfoLogs" checked>
                                            <label class="form-check-label" for="showInfoLogs">Info</label>
                            </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="showWarningLogs" checked>
                                            <label class="form-check-label" for="showWarningLogs">Warning</label>
                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="showErrorLogs" checked>
                                            <label class="form-check-label" for="showErrorLogs">Error</label>
                    </div>
                            </div>
                                    <div class="logs-container mt-3 bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                                        <pre id="logsContent" class="mb-0"><code>Carregando logs...</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
  </div>
</div>

<!-- Modal para geração de dados -->
<div class="modal fade" id="modalGerarDados" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-database me-2"></i> Gerar Dados de Teste</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
                <form id="formGerarDados">
                    <div class="mb-3">
                        <label for="tipoDados" class="form-label">Tipo de Dados</label>
                        <select class="form-select" id="tipoDados" required>
                            <option value="parceiros" selected>Parceiros Técnicos</option>
                            <option value="notificacoes">Notificações</option>
                        </select>
            </div>
                    <div class="mb-3">
                        <label for="quantidadeDados" class="form-label">Quantidade</label>
                        <input type="number" class="form-control" id="quantidadeDados" min="1" max="50" value="5" required>
          </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="gerarExperiencia" checked>
                        <label class="form-check-label" for="gerarExperiencia">
                            Gerar dados de experiência profissional
                        </label>
        </div>
                </form>
      </div>
      <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="gerarDados()">Gerar Dados</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Carregar a biblioteca DevTools -->
<script src="{{ url_for('static', filename='js/developer-tools.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
        // Verificar status do modo debug
        fetch('/admin/developer/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('debugModeSwitch').checked = data.debug;
            })
            .catch(error => console.error('Erro ao verificar status do modo debug:', error));
            
        // Event listener para o switch de debug
        document.getElementById('debugModeSwitch').addEventListener('change', function(e) {
            toggleDebugMode(e.target.checked);
        });
        
        // Inicializar logs
        visualizarLogs();
        
        // Inicializar as ferramentas do desenvolvedor
        if (window.DevTools) {
            console.log('Inicializando DevTools...');
            DevTools.verificarElementosHTML();
            
            // Substituir a função local pela função robusta do DevTools
            window.mostrarAlertaOriginal = window.mostrarAlerta;
            window.mostrarAlerta = function(elementId, mensagem, tipo) {
                return DevTools.mostrarAlerta(elementId, mensagem, tipo);
            };
            
            // Também substituir a função de envio de parceiro
            const form = document.getElementById('formParceiroTeste');
            if (form) {
                form.removeEventListener('submit', enviarParceiro);
                form.addEventListener('submit', function(event) {
                    DevTools.enviarParceiro(event);
                });
                console.log('Event listener do formulário substituído por versão robusta');
        }
    } else {
            console.warn('DevTools não encontrado, usando funções locais de fallback...');
            // Verificar elementos necessários com a versão local
            verificarElementosNecessarios();
        }
        
        // Adicionar validação para WhatsApp único
        document.getElementById('whatsappParceiro').addEventListener('blur', function() {
            validarWhatsAppUnico(this.value);
        });
    });
    
    // Verificar se WhatsApp já existe no banco
    function validarWhatsAppUnico(whatsapp) {
        if (whatsapp.length !== 11 || !/^\d+$/.test(whatsapp)) {
            return; // Não é um número válido ainda, não validar
        }
        
        fetch('/admin/developer/verificar-whatsapp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
            body: JSON.stringify({ whatsapp: whatsapp })
        })
        .then(response => response.json())
        .then(data => {
            const input = document.getElementById('whatsappParceiro');
            if (data.exists) {
                input.setCustomValidity('Este número já está cadastrado');
                input.classList.add('is-invalid');
                // Mostrar feedback visual
                if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'Este número já está cadastrado no sistema.';
                    input.parentNode.insertBefore(feedback, input.nextSibling);
                }
        } else {
                input.setCustomValidity('');
                input.classList.remove('is-invalid');
                // Remover feedback se existir
                if (input.nextElementSibling && input.nextElementSibling.classList.contains('invalid-feedback')) {
                    input.nextElementSibling.remove();
                }
            }
        })
        .catch(error => {
            console.error('Erro ao verificar WhatsApp:', error);
        });
    }
    
    // Função para verificar e criar elementos necessários (fallback se DevTools não estiver disponível)
    function verificarElementosNecessarios() {
        console.log('Verificando elementos necessários...');
        
        // Lista de elementos essenciais
        const elementosNecessarios = [
            'resultadoTeste',
            'resultadoDados',
            'alertaResultado',
            'mensagemResultado'
        ];
        
        elementosNecessarios.forEach(id => {
            if (!document.getElementById(id)) {
                console.warn(`Elemento #${id} não encontrado. Criando dinamicamente...`);
                
                // Criar o elemento
                const elemento = document.createElement('div');
                elemento.id = id;
                elemento.className = 'alert mt-3';
                elemento.style.display = 'none';
                
                // Adicionar ao DOM na localização apropriada
                let container;
                
                if (id === 'resultadoTeste') {
                    // Buscar container de Debug
                    const debugCard = document.querySelector('.card-header.bg-secondary');
                    container = debugCard ? debugCard.closest('.card').querySelector('.card-body') : null;
                } else if (id === 'resultadoDados') {
                    // Buscar container de Dados de Teste
                    const testDataCard = document.querySelector('.card-header.bg-info');
                    container = testDataCard ? testDataCard.closest('.card').querySelector('.card-body') : null;
        } else {
                    // Buscar container do formulário
                    const form = document.querySelector('form#formParceiroTeste');
                    container = form ? form.closest('.card-body') : null;
                }
                
                // Se não encontrou, usa o primeiro card-body ou o body
                if (!container) {
                    container = document.querySelector('.card-body') || document.body;
                }
                
                container.appendChild(elemento);
                console.log(`Elemento #${id} criado com sucesso!`);
        }
    });
}

    // Função para alternar modo debug
    function toggleDebugMode(enabled) {
        fetch('/admin/developer/toggle-debug', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
            body: JSON.stringify({ debug: enabled })
        })
        .then(response => {
            if (response.ok) {
                mostrarAlerta('resultadoTeste', `Modo debug ${enabled ? 'ativado' : 'desativado'} com sucesso!`, 'success');
        } else {
                mostrarAlerta('resultadoTeste', 'Erro ao alterar modo debug.', 'danger');
        }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('resultadoTeste', 'Erro ao alterar modo debug: ' + error, 'danger');
    });
}

    // Função para testar conexão com o banco de dados
    function testarDB() {
        mostrarAlerta('resultadoTeste', 'Testando conexão...', 'info');
        
    fetch('/admin/developer/testar-db')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                    mostrarAlerta('resultadoTeste', `Conexão com o banco de dados estabelecida com sucesso! Total de usuários: ${data.total_users}`, 'success');
        } else {
                    mostrarAlerta('resultadoTeste', `Erro ao conectar ao banco de dados: ${data.error}`, 'danger');
        }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('resultadoTeste', 'Erro ao testar conexão: ' + error, 'danger');
    });
}

    // Função para verificar estrutura do banco
function verificarEstrutura() {
        mostrarAlerta('resultadoTeste', 'Verificando estrutura...', 'info');
        
    fetch('/admin/developer/verificar-estrutura')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                    let mensagem = '<p>Estrutura verificada:</p><ul>';
            data.tabelas.forEach(tabela => {
                        mensagem += `<li>${tabela.nome}: ${tabela.status}</li>`;
                    });
                    mensagem += '</ul>';
                    
                    document.getElementById('resultadoTeste').innerHTML = mensagem;
                    document.getElementById('resultadoTeste').className = 'alert alert-success mt-3';
                    document.getElementById('resultadoTeste').style.display = 'block';
        } else {
                    mostrarAlerta('resultadoTeste', `Erro ao verificar estrutura: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('resultadoTeste', 'Erro ao verificar estrutura: ' + error, 'danger');
            });
    }
    
    // Função para visualizar logs
    function visualizarLogs() {
        document.getElementById('logsContent').textContent = 'Carregando logs...';
        
        fetch('/admin/developer/visualizar-logs')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                    // Filtrar logs conforme configuração
                    let logs = data.logs;
                    
                    if (!document.getElementById('showDebugLogs').checked) {
                        logs = logs.filter(log => !log.toLowerCase().includes('[debug]'));
                    }
                    
                    if (!document.getElementById('showInfoLogs').checked) {
                        logs = logs.filter(log => !log.toLowerCase().includes('[info]'));
                    }
                    
                    if (!document.getElementById('showWarningLogs').checked) {
                        logs = logs.filter(log => !log.toLowerCase().includes('[warning]'));
                    }
                    
                    if (!document.getElementById('showErrorLogs').checked) {
                        logs = logs.filter(log => !log.toLowerCase().includes('[error]'));
                    }
                    
                    document.getElementById('logsContent').textContent = logs.join('\n');
                } else {
                    document.getElementById('logsContent').textContent = 'Erro ao carregar logs: ' + data.error;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('logsContent').textContent = 'Erro ao carregar logs: ' + error;
            });
    }
    
    // Função para abrir modal de geração de dados
    function abrirModalGerarDados() {
        const modal = new bootstrap.Modal(document.getElementById('modalGerarDados'));
        modal.show();
    }
    
    // Função para gerar dados de teste
    function gerarDados() {
        const tipo = document.getElementById('tipoDados').value;
        const quantidade = parseInt(document.getElementById('quantidadeDados').value, 10);
        const gerarExperiencia = document.getElementById('gerarExperiencia').checked;
        
        // Esconder o modal
        bootstrap.Modal.getInstance(document.getElementById('modalGerarDados')).hide();
        
        // Mostrar mensagem de carregamento
        mostrarAlerta('resultadoDados', 'Gerando dados...', 'info');
        
        if (tipo === 'parceiros') {
            // Lista de especialidades válidas
            const especialidadesValidas = [
                "Solucoes ISP", "Telefonia VoIP", "Fibra Óptica", "Servidores TI",
                "Infraestrutura Fisica", "Wi-Fi Corporativo", "Radio Comunicacao",
            "Consultoria"
        ];
        
            // Estados válidos
            const estadosValidos = ["MA", "PI", "CE", "PA", "PE"];
            
            // Função para gerar um item aleatório de um array
            const itemAleatorio = (array) => array[Math.floor(Math.random() * array.length)];
            
            // Função para gerar um número de WhatsApp único
            const gerarWhatsApp = (index) => {
                // Garantir números diferentes usando o índice e timestamp
                const timestamp = new Date().getTime().toString().slice(-4);
                const base = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                return `98${base}${index}${timestamp}`.slice(0, 11);
            };
            
            // Função para selecionar 1-3 especialidades aleatórias
            const selecionarEspecialidades = () => {
                const quantidade = Math.floor(Math.random() * 3) + 1; // 1 a 3 especialidades
                const selecionadas = [];
                
                for (let i = 0; i < quantidade; i++) {
                    const esp = itemAleatorio(especialidadesValidas);
                    if (!selecionadas.includes(esp)) {
                        selecionadas.push(esp);
                    }
                }
                
                // Garantir pelo menos uma especialidade
                if (selecionadas.length === 0) {
                    selecionadas.push("Solucoes ISP");
                }
                
                return selecionadas;
            };
            
            // Gerar array de parceiros de teste
            const parceiros = [];
            for (let i = 0; i < quantidade; i++) {
                // Gerar ID único para este parceiro
                const uniqueId = `${Math.floor(Math.random() * 9999)}_${i}_${new Date().getTime()}`;
                
                // Gerar dados básicos para cada parceiro
                parceiros.push({
                    nome_completo: `Teste Parceiro ${uniqueId}`.substring(0, 80),
                    email: `teste${uniqueId}@exemplo.com`.substring(0, 100),
                    whatsapp: gerarWhatsApp(i),
                    cidade: 'Sao Luis',
                    estado: itemAleatorio(estadosValidos),
                    especialidades: selecionarEspecialidades(),
                    experiencia: gerarExperiencia ? 
                        'Parceiro gerado automaticamente para testes. Experiência em instalação e configuração de equipamentos de rede, FTTH e roteadores.' : 
                        'Parceiro de teste sem experiência registrada.',
                    is_test_data: true,
                    status: 'Pendente'
                });
            }
            
            console.log('Parceiros a serem criados:', parceiros);
            
            // Enviar para a rota correta de gerar parceiros teste
        fetch('/admin/developer/gerar-parceiros-teste', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
                body: JSON.stringify({
                    parceiros: parceiros
                })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                    mostrarAlerta('resultadoDados', data.message, 'success');
                    console.log('Resposta do servidor:', data);
                    
                if (data.erros && data.erros.length > 0) {
                        console.warn('Erros encontrados:', data.erros);
                        // Adicionar detalhes dos erros na mensagem
                        const detalheErros = document.createElement('div');
                        detalheErros.className = 'mt-3 small';
                        detalheErros.innerHTML = `<p class="text-warning">Avisos (${data.erros.length}):</p><ul>`;
                        data.erros.slice(0, 5).forEach(erro => {
                            detalheErros.innerHTML += `<li>${erro}</li>`;
                        });
                        if (data.erros.length > 5) {
                            detalheErros.innerHTML += `<li>... e mais ${data.erros.length - 5} avisos</li>`;
                        }
                        detalheErros.innerHTML += '</ul>';
                        document.getElementById('resultadoDados').appendChild(detalheErros);
                    }
                    } else {
                    mostrarAlerta('resultadoDados', 'Erro: ' + data.message, 'danger');
                    console.error('Erro do servidor:', data);
                    }
                })
                .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('resultadoDados', 'Erro ao gerar parceiros: ' + error, 'danger');
            });
                            } else {
            // Para outros tipos de dados, manter a implementação original
            fetch('/admin/developer/gerar-dados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tipo: tipo,
                    quantidade: quantidade,
                    gerar_experiencia: gerarExperiencia
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta('resultadoDados', data.message, 'success');
            } else {
                    mostrarAlerta('resultadoDados', 'Erro: ' + data.message, 'danger');
            }
        })
        .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('resultadoDados', 'Erro ao gerar dados: ' + error, 'danger');
            });
        }
    }
    
    // Função para limpar dados de teste
    function limparDadosTeste() {
        if (!confirm('Tem certeza que deseja limpar todos os dados de teste? Esta ação não pode ser desfeita.')) {
            return;
        }

        mostrarAlerta('resultadoDados', 'Limpando dados...', 'info');
        
        fetch('/admin/developer/limpar-dados', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('resultadoDados', 'Dados de teste removidos com sucesso!', 'success');
            } else {
                mostrarAlerta('resultadoDados', 'Erro ao limpar dados: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('resultadoDados', 'Erro ao limpar dados: ' + error, 'danger');
        });
    }
    
    // Função para verificar a estrutura da tabela parceiros_tecnicos
function verificarTabelaParceiros() {
        mostrarAlerta('resultadoDados', 'Verificando estrutura da tabela parceiros_tecnicos...', 'info');
        
    fetch('/admin/developer/verificar-tabela-parceiros')
    .then(response => response.json())
    .then(data => {
            if (data.success) {
                    let html = '<div class="p-3 bg-light border rounded"><h6>Estrutura da tabela parceiros_tecnicos:</h6>';
                    
                    if (data.colunas && data.colunas.length > 0) {
                        html += '<table class="table table-sm"><thead><tr><th>Coluna</th><th>Tipo</th><th>Restrições</th></tr></thead><tbody>';
                        data.colunas.forEach(col => {
                            html += `<tr><td>${col.nome || 'N/A'}</td><td>${col.tipo || 'N/A'}</td><td>${col.restricoes || ''}</td></tr>`;
                        });
                        html += '</tbody></table>';
                    } else {
                        html += '<p class="text-warning">Nenhuma informação de coluna encontrada</p>';
                    }
                    
                    if (data.erros_comuns) {
                        html += '<div class="mt-3"><h6>Possíveis problemas:</h6><ul>';
                        Object.entries(data.erros_comuns).forEach(([campo, erro]) => {
                            html += `<li><strong>${campo}:</strong> ${erro}</li>`;
                        });
                        html += '</ul></div>';
                    }
                
                html += '</div>';
                
                    document.getElementById('resultadoDados').innerHTML = html;
                    document.getElementById('resultadoDados').className = 'alert alert-info mt-3';
                    document.getElementById('resultadoDados').style.display = 'block';
            } else {
                    mostrarAlerta('resultadoDados', 'Erro ao verificar estrutura: ' + (data.message || 'Erro desconhecido'), 'danger');
            }
        })
        .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('resultadoDados', 'Erro ao verificar tabela: ' + error, 'danger');
            });
    }
    
    // Função para enviar formulário do parceiro
    function enviarParceiro(event) {
        event.preventDefault();
        
        // Mostrar mensagem de carregamento
        mostrarAlerta('alertaResultado', 'Enviando dados...', 'info');
        
        // Obter dados do formulário
        const form = document.getElementById('formParceiroTeste');
        const formData = new FormData(form);
        
        // Converter para JSON
        const dadosParceiro = {};
        formData.forEach((valor, chave) => {
            if (chave === 'especialidades') {
                // Pegar múltiplos valores selecionados
                const select = document.getElementById('especialidadesParceiro');
                const selectedOptions = Array.from(select.selectedOptions).map(option => option.value);
                dadosParceiro[chave] = selectedOptions;
            } else if (chave === 'is_test_data') {
                dadosParceiro[chave] = true; // Sempre true para o checkbox
        } else {
                dadosParceiro[chave] = valor;
            }
        });
        
        // Garantir que is_test_data seja true mesmo se o checkbox não estiver marcado
        if (!dadosParceiro.hasOwnProperty('is_test_data')) {
            dadosParceiro['is_test_data'] = true;
        }
        
        // Enviar para o backend
        fetch('/admin/developer/inserir-parceiro', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dadosParceiro)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('alertaResultado', 'Parceiro inserido com sucesso!', 'success');
                
                // Limpar o formulário ou preparar para nova entrada
                document.getElementById('whatsappParceiro').value = '';
                document.getElementById('emailParceiro').value = `teste.${Math.floor(Math.random() * 100000)}@exemplo.com`;
                
                // Mostrar detalhes do parceiro inserido
                let detalhes = `<div class="mt-3 p-3 bg-light rounded">
                    <h6>Parceiro inserido:</h6>
                    <p><strong>ID:</strong> ${data.id}<br>
                    <strong>Nome:</strong> ${data.nome_completo}<br>
                    <strong>Email:</strong> ${data.email}<br>
                    <strong>WhatsApp:</strong> ${data.whatsapp}</p>
                </div>`;
                
                document.getElementById('mensagemResultado').innerHTML = detalhes;
                document.getElementById('mensagemResultado').style.display = 'block';
        } else {
                mostrarAlerta('alertaResultado', `Erro ao inserir parceiro: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('alertaResultado', 'Erro ao enviar dados: ' + error, 'danger');
        });
    }
    
    // Função auxiliar para mostrar alertas - versão melhorada
    function mostrarAlerta(elementId, mensagem, tipo) {
        // Verificar se o elemento existe, se não, criar
        let elemento = document.getElementById(elementId);
        if (!elemento) {
            console.warn(`Elemento #${elementId} não encontrado. Criando...`);
            elemento = document.createElement('div');
            elemento.id = elementId;
            elemento.className = 'alert mt-3';
            elemento.style.display = 'none';
            
            // Encontrar o container apropriado para adicionar o elemento
            let container;
            
            // Tentar encontrar containers específicos com navegação mais precisa
            if (elementId === 'resultadoTeste') {
                const debugCard = document.querySelector('.card-header.bg-secondary');
                container = debugCard ? debugCard.closest('.card').querySelector('.card-body') : null;
            } else if (elementId === 'resultadoDados') {
                const testDataCard = document.querySelector('.card-header.bg-info');
                container = testDataCard ? testDataCard.closest('.card').querySelector('.card-body') : null;
        } else {
                const form = document.querySelector('form#formParceiroTeste');
                container = form ? form.closest('.card-body') : null;
            }
            
            // Fallback para o body se não encontrar container específico
            if (!container) {
                container = document.querySelector('.card-body') || document.body;
            }
            
            container.appendChild(elemento);
            console.log(`Elemento #${elementId} criado e adicionado ao DOM`);
        }
        
        // Agora é seguro definir as propriedades
        elemento.innerHTML = mensagem;
        elemento.className = `alert alert-${tipo} mt-3`;
        elemento.style.display = 'block';
        
        // Scroll até o alerta se não estiver visível
        if (!isElementInViewport(elemento)) {
            elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        return elemento;
    }
    
    // Função auxiliar para verificar se um elemento está visível na viewport
    function isElementInViewport(el) {
        const rect = el.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
}
</script>
{% endblock %} 